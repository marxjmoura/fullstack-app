<!doctype html><html lang="pt"><head><meta charset="utf-8"><meta name="theme-color" content="#ffffff"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Marx J. Moura"><meta name="description" content="Pensar no padrão de arquitetura de microsserviços nos leva a pensar em API gateway. Então, vamos discutir um pouco e implementar uma API gateway usando o framework Ocelot."><meta property="og:title" content="API gateway com ASP.NET Core e Ocelot"><meta property="og:image" content="https://fullstack.app/posts/2019/08/20/cover.png"><meta property="og:description" content="Pensar no padrão de arquitetura de microsserviços nos leva a pensar em API gateway. Então, vamos discutir um pouco e implementar uma API gateway usando o framework Ocelot."><meta property="og:url" content="https://fullstack.app/br/posts/2019/08/20/api-gateway-com-aspnet-core-e-ocelot.html"><title>API gateway com ASP.NET Core e Ocelot</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,700&display=swap"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" integrity="sha256-UzFD2WYH2U1dQpKDjjZK72VtPeWP50NoJjd26rnAdUI=" crossorigin="anonymous"><link rel="stylesheet" href="/blog.min.css?v=1.2.0"></head><body><div class="container"><div class="text-right mb-3"><div class="dropdown"><button type="button" class="btn btn-sm dropdown-toggle" data-toggle="dropdown">BR</button><div class="dropdown-menu"><a href="/posts/2019/08/20/api-gateway-with-aspnet-core-and-ocelot.html" class="dropdown-item">EN</a></div></div></div><div class="header"><h1><a href="/br">Full-Stack Applications</a></h1><div class="techs"><svg><use href="/images/techs.svg#netcore"/></svg> <svg><use href="/images/techs.svg#vue"/></svg> <svg><use href="/images/techs.svg#postgresql"/></svg> <svg><use href="/images/techs.svg#rabbitmq"/></svg> <svg><use href="/images/techs.svg#nginx"/></svg> <svg><use href="/images/techs.svg#ubuntu"/></svg> <svg><use href="/images/techs.svg#aws"/></svg> <svg><use href="/images/techs.svg#github"/></svg> <svg><use href="/images/techs.svg#circleci"/></svg></div></div><form method="get" action="https://www.google.com/search" class="google-search"><input type="hidden" name="sitesearch" value="fullstack.app"> <input type="text" name="q" class="form-control form-control-sm" placeholder="Google"></form><small>20 de agosto de 2019</small><h1>API gateway com ASP.NET Core e Ocelot</h1><figure><img src="/posts/2019/08/20/cover.svg" alt="API gateway com Ocelot"></figure><p>Pensar no padrão de arquitetura de microsserviços nos leva a pensar em API gateway. Então, vamos discutir um pouco e implementar uma API gateway usando o <a href="https://threemammals.com/ocelot/">framework Ocelot </a>.</p><p>Eu li dois ótimos artigos, a <a href="https://microservices.io/patterns/apigateway.html">microservices.io</a> e a <a href="https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway">documentação da Microsoft</a>, que me ajudaram muito a entender o uso de uma API gateway. Eu também implementei uma API gateway no meu projeto de código aberto <a href="https://github.com/storefront-community/api-gateway">Storefront Community</a>.</p><p>De maneira breve, uma API gateway é um ponto de entrada para todos os nossos serviços. Isso nos permite ter um único domínio para todas as nossas APIs, ao invés de ter um subdomínio para cada uma delas. Com subdomínios nós temos a preocupação de SSL para cada API, frontend se conectando com múltiplas APIs gerando mais esforço para lidar com autorização, entre outros.</p><p>O <a href="https://threemammals.com/ocelot/">Ocelot</a> é framwork de <a href="https://github.com/ThreeMammals/Ocelot">código aberto</a> para construir API gateway com .NET. Assim que finalizarmos a implementação da nossa API gateway alcançaremos isso:</p><ul><li>exemplo.com/api1/dados</li><li>exemplo.com/api2/dados</li><li>exemplo.com/api3/dados</li></ul><p></p><p>Ao invés disso (sem API gateway):</p><ul><li>api1.exemplo.com/dados</li><li>api2.exemplo.com/dados</li><li>api3.exemplo.com/dados</li></ul><p></p><p>Para autorização nós usaremos o <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2&tabs=netcore-cli">ASP.NET Core Identity</a>, mas discutiremos isso em um outro post.</p><p>Então, vamos começar. Eu estou usando o <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-new?tabs=netcore22">.NET Core CLI</a> e admitindo que você já tem o <a href="https://dotnet.microsoft.com">.NET Core SDK</a> instalado.</p><p>Primeiro crie um diretório para o projeto usando o comando <code>mkdir</code> e navege para ele usando o comando <code>cd</code>:</p><p><pre><code>mkdir ApiGateway</code></pre></p><p><pre><code>cd ApiGateway</code></pre></p><p>Dentro do diretório <code>ApiGateway</code> vamos criar um projeto web vazio:</p><p><pre><code>dotnet new web</code></pre></p>A seguida adicione o pacote do Ocelot ao projeto:<p><pre><code>dotnet add package Ocelot</code></pre></p><p>O arquivo <code>ApiGateway.csproj</code> deve estar parecido com isso:</p><p><pre><code>&lt;Project Sdk&#x3D;&quot;Microsoft.NET.Sdk.Web&quot;&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;netcoreapp2.2&lt;/TargetFramework&gt;
    &lt;AspNetCoreHostingModel&gt;InProcess&lt;/AspNetCoreHostingModel&gt;
  &lt;/PropertyGroup&gt;
  &lt;ItemGroup&gt;
    &lt;PackageReference Include&#x3D;&quot;Microsoft.AspNetCore.App&quot; /&gt;
    &lt;PackageReference Include&#x3D;&quot;Ocelot&quot; Version&#x3D;&quot;13.5.2&quot; /&gt;
  &lt;/ItemGroup&gt;
&lt;/Project&gt;
</code></pre></p><p>Ainda no diretório raíz do projeto vamos criar o arquivo de configuração <code>ocelot.json</code> com o seguinte conteúdo:</p><p><pre><code>{
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;
  },
  &quot;ReRoutes&quot;: [
    {
      &quot;UpstreamPathTemplate&quot;: &quot;/mocky/{path}&quot;,
      &quot;UpstreamHttpMethod&quot;: [
        &quot;Get&quot;,
        &quot;Post&quot;,
        &quot;Put&quot;,
        &quot;Delete&quot;,
        &quot;Options&quot;
      ],
      &quot;DownstreamPathTemplate&quot;: &quot;/v2/{path}&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;DownstreamHostAndPorts&quot;: [
        {
          &quot;Host&quot;: &quot;www.mocky.io&quot;,
          &quot;Port&quot;: 80
        }
      ]
    }
  ]
}
</code></pre></p><p>Eu explicarei o que significa cada propriedade mas você também pode usar a <a href="https://ocelot.readthedocs.io/en/latest/introduction/gettingstarted.html">documentação do Ocelot</a> como referência:</p><ul><li><code>GlobalConfiguration.BaseUrl</code>: A URL onde nossa API gateway está executando.</li><li><code>ReRoutes</code>: Configuração de todas as rotas de uma requisição para outras APIs.</li><li><code>ReRoutes.UpstreamPathTemplate</code>: O padrão de rota que corresponde com uma API.</li><li><code>ReRoutes.UpstreamHttpMethod</code>: Define os verbos HTTP que serão roteados por essa configuração.</li><li><code>ReRoutes.DownstreamPathTemplate</code>: A variável que criamos para passar para a próxima rota. Pode ser qualquer nome e mais do que uma, ex.: <code>/foo/{var1}/data/{var2}</code>.</li><li><code>ReRoutes.DownstreamScheme</code>: O protocolo que estamos utilizando. Neste caso <code>http</code>.</li><li><code>ReRoutes.DownstreamHostAndPorts</code>: O host e porta onde a API de destino está executando.</li></ul><p></p><p>O resultado é: toda requisição usando os métodos <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code> e <code>OPTIONS</code> de <code>http://localhost:5000/mocky/{paht}</code> serão roteadas para <code>http://www.mocky.io/v2/{path}</code> (não confundir com redirecionamento). Onde <code>path</code> pode assumir qualquer valor e será repassado para API de destino.</p><p>Agora precisamos fazer com que nossa API gateway leia o arquivo de configuração <code>ocelot.json</code>. Iremos fazer isso através da classe <code>Program</code> e para isso, vamos substituir o conteúdo do arquivo <code>Program.cs</code> com o seguinte:</p><p><pre><code>using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;

namespace ApiGateway
{
    public sealed class Program
    {
        public static void Main(string[] args)
        {
            CreateWebHostBuilder(args).Build().Run();
        }

        public static IWebHostBuilder CreateWebHostBuilder(string[] args) &#x3D;&gt;
            WebHost.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration((host, config) &#x3D;&gt;
                {
                    config.AddJsonFile(&quot;ocelot.json&quot;);
                })
                .UseStartup&lt;Startup&gt;();
    }
}
</code></pre></p><p>Para que nossa gateway API utilize o Ocelot precisamos configurá-la na classe <code>Startup</code>. Substitua o conteúdo do arquivo <code>Startup.cs</code> pelo seguinte:</p><p><pre><code>using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Ocelot.DependencyInjection;
using Ocelot.Middleware;

namespace ApiGateway
{
    public sealed class Startup
    {
        public readonly IConfiguration _configuration;

        public Startup(IConfiguration configuration)
        {
            _configuration &#x3D; configuration;
        }

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddOcelot(_configuration);
        }

        public void Configure(IApplicationBuilder app, IHostingEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            app.UseOcelot().Wait();
        }
    }
}
</code></pre></p><p>Agora, vamos executar nossa API gateway (por padrão em <code>http://localhost:5000</code>):</p><p><pre><code>dotnet run</code></pre></p><p>Quando você acessar <code>http://localhost:5000/mocky/5185415ba171ea3a00704eed</code> no seu browser você deve obter:</p><p><pre><code>{"hello": "world"}</code></pre></p><p>E o que é o <a href="https://www.mocky.io/">mocky.io</a>? É uma RESTful API fictícia onde podemos simular respostas JSON.</p><div class="author"><img src="/images/marxjmoura.jpg" alt="marxjmoura"><div><p class="mb-3">Eu sou Marx J. Moura. Neste blog escrevo sobre arquitetura de microsserviços e desenvolvimento de aplicações web.</p><p><a href="https://github.com/marxjmoura/" class="p-1"><i class="fab fa-lg fa-github"></i> </a><a href="https://www.linkedin.com/in/marxjmoura/" class="p-1"><i class="fab fa-lg fa-linkedin"></i></a></p></div></div><div id="disqus_thread"></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/js/all.min.js" integrity="sha256-xzrHBImM2jn9oDLORlHS1/0ekn1VyypEkV1ALvUx8lU=" crossorigin="anonymous"></script><script src="/blog.min.js?v=1.2.0"></script><script>var disqus_config = function () {
      this.page.url = 'https://fullstack.app/br/posts/2019/08/20/api-gateway-com-aspnet-core-e-ocelot.html';
      this.page.identifier = '2019/08/20/api-gateway-with-aspnet-core-and-ocelot';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://fullstack-app.disqus.com/embed.js';
      s.setAttribute('data-timestamp', + new Date());
      (d.head || d.body).appendChild(s);
    })();</script></body></html>