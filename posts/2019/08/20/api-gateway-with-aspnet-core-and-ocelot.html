<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="theme-color" content="#ffffff"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Marx J. Moura"><meta name="description" content="Thinking about the microservices architecture pattern leads us to think of the API gateway. So, let&#x27;s disccuss a bit and implement an API gateway using the Ocelot framework."><meta property="og:title" content="API gateway with ASP.NET Core and Ocelot"><meta property="og:image" content="https://fullstack.app/posts/2019/08/20/cover.png"><meta property="og:description" content="Thinking about the microservices architecture pattern leads us to think of the API gateway. So, let&#x27;s disccuss a bit and implement an API gateway using the Ocelot framework."><meta property="og:url" content="https://fullstack.app/posts/2019/08/20/api-gateway-with-aspnet-core-and-ocelot.html"><title>API gateway with ASP.NET Core and Ocelot</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,700&display=swap"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" integrity="sha256-UzFD2WYH2U1dQpKDjjZK72VtPeWP50NoJjd26rnAdUI=" crossorigin="anonymous"><link rel="stylesheet" href="/blog.min.css"></head><body><div class="container"><div class="text-right mb-3"><div class="dropdown"><button type="button" class="btn btn-sm dropdown-toggle" data-toggle="dropdown">EN</button><div class="dropdown-menu"><a href="/br/posts/2019/08/20/api-gateway-com-aspnet-core-e-ocelot.html" class="dropdown-item">BR</a> <a href="/" class="dropdown-item">EN</a></div></div></div><div class="header"><h1><a href="/">Full-Stack Applications</a></h1><div class="techs"><svg><use href="/images/techs.svg#netcore"/></svg> <svg><use href="/images/techs.svg#vue"/></svg> <svg><use href="/images/techs.svg#postgresql"/></svg> <svg><use href="/images/techs.svg#rabbitmq"/></svg> <svg><use href="/images/techs.svg#nginx"/></svg> <svg><use href="/images/techs.svg#ubuntu"/></svg> <svg><use href="/images/techs.svg#aws"/></svg> <svg><use href="/images/techs.svg#github"/></svg> <svg><use href="/images/techs.svg#circleci"/></svg></div></div><form method="get" action="https://www.google.com/search" class="google-search"><input type="hidden" name="sitesearch" value="fullstack.app"> <input type="text" name="q" class="form-control form-control-sm" placeholder="Google"></form><small>20 August 2019</small><h1>API gateway with ASP.NET Core and Ocelot</h1><figure><img src="/posts/2019/08/20/cover.svg" alt="API gateway with Ocelot"></figure><p>Thinking about the microservices architecture pattern leads us to think of the API gateway. So, let's disccuss a bit and implement an API gateway using the <a href="https://threemammals.com/ocelot/">Ocelot framework</a>.</p><p>I've read two great articles, the <a href="https://microservices.io/patterns/apigateway.html">microservices.io</a> and the <a href="https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway">Microsoft documentation</a> that help me a lot to understand the use of the API gateway. I also implemented an API gateway on my open source project <a href="https://github.com/storefront-community/api-gateway">Storefront Community</a>.</p><p>Briefly an API gateway is an entry point for all or our services. This allow us to have a single domain for all of our APIs, rather than having a subdomain for each of them. With the subdomains we have the concern about SSL for each API, frontend connecting to several APIs generating more effort to deal with authorization, among others.</p><p>The <a href="https://threemammals.com/ocelot/">Ocelot</a> is an <a href="https://github.com/ThreeMammals/Ocelot">open source</a> API gateway framework for .NET. Once we have finished implementing our API gateway we will achieve this:</p><ul><li>example.com/api1/data</li><li>example.com/api2/data</li><li>example.com/api3/data</li></ul><p></p><p>Instead of this (without API gateway):</p><ul><li>api1.example.com/data</li><li>api2.example.com/data</li><li>api3.example.com/data</li></ul><p></p><p>For authorization we will use the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2&tabs=netcore-cli">ASP.NET Core Identity</a>, but we will discuss this in a next post.</p><p>So, let's start. I'm using <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-new?tabs=netcore22">.NET Core CLI</a> and I presume that you already have the <a href="https://dotnet.microsoft.com">.NET Core SDK</a> installed.</p><p>First create a folder to the project using de command <code>mkdir</code> and go to it using the command <code>cd</code>:</p><p><pre><code>mkdir ApiGateway</code></pre></p><p><pre><code>cd ApiGateway</code></pre></p><p>Inside the <code>ApiGateway</code> folder let's create an empty web project:</p><p><pre><code>dotnet new web</code></pre></p>Then add the Ocelot package to the project:<p><pre><code>dotnet add package Ocelot</code></pre></p><p>The <code>ApiGateway.csproj</code> file should look like this:</p><p><pre><code>&lt;Project Sdk&#x3D;&quot;Microsoft.NET.Sdk.Web&quot;&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;netcoreapp2.2&lt;/TargetFramework&gt;
    &lt;AspNetCoreHostingModel&gt;InProcess&lt;/AspNetCoreHostingModel&gt;
  &lt;/PropertyGroup&gt;
  &lt;ItemGroup&gt;
    &lt;PackageReference Include&#x3D;&quot;Microsoft.AspNetCore.App&quot; /&gt;
    &lt;PackageReference Include&#x3D;&quot;Ocelot&quot; Version&#x3D;&quot;13.5.2&quot; /&gt;
  &lt;/ItemGroup&gt;
&lt;/Project&gt;
</code></pre></p><p>Still in the root folder of the project let's create the <code>ocelot.json</code> configuration file with the following content:</p><p><pre><code>{
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;
  },
  &quot;ReRoutes&quot;: [
    {
      &quot;UpstreamPathTemplate&quot;: &quot;/mocky/{path}&quot;,
      &quot;UpstreamHttpMethod&quot;: [
        &quot;Get&quot;,
        &quot;Post&quot;,
        &quot;Put&quot;,
        &quot;Delete&quot;,
        &quot;Options&quot;
      ],
      &quot;DownstreamPathTemplate&quot;: &quot;/v2/{path}&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;DownstreamHostAndPorts&quot;: [
        {
          &quot;Host&quot;: &quot;www.mocky.io&quot;,
          &quot;Port&quot;: 80
        }
      ]
    }
  ]
}
</code></pre></p><p>I will explain what means each property but you may also refer to <a href="https://ocelot.readthedocs.io/en/latest/introduction/gettingstarted.html">Ocelot documentation</a>:</p><ul><li><code>GlobalConfiguration.BaseUrl</code>: The URL from where our API gateway is running.</li><li><code>ReRoutes</code>: Configuration of all routing of one request to the other APIs.</li><li><code>ReRoutes.UpstreamPathTemplate</code>: The route pattern to match an API.</li><li><code>ReRoutes.UpstreamHttpMethod</code>: Defines the HTTP verbs that will be routed by this configuration.</li><li><code>ReRoutes.DownstreamPathTemplate</code>: The variable we create to pass to the next route. Could be any name and more than one, e.g. <code>/foo/{var1}/data/{var2}</code>.</li><li><code>ReRoutes.DownstreamScheme</code>: The protocol we are using. In this case <code>http</code>.</li><li><code>ReRoutes.DownstreamHostAndPorts</code>: The host and port where the target API is running.</li></ul><p></p><p>The result is: every request using the methods <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code> and <code>OPTIONS</code> from <code>http://localhost:5000/mocky/{paht}</code> will be routed to <code>http://www.mocky.io/v2/{path}</code> (do not confuse with redirect). Where the <code>path</code> can be any value and will be passed to the target API.</p><p>Now we need our API gateway to read the configuration file <code>ocelot.json</code>. We will do this through the <code>Program</code> class and for that, we will replace the content of the <code>Program.cs</code> file with the following:</p><p><pre><code>using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;

namespace ApiGateway
{
    public sealed class Program
    {
        public static void Main(string[] args)
        {
            CreateWebHostBuilder(args).Build().Run();
        }

        public static IWebHostBuilder CreateWebHostBuilder(string[] args) &#x3D;&gt;
            WebHost.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration((host, config) &#x3D;&gt;
                {
                    config.AddJsonFile(&quot;ocelot.json&quot;);
                })
                .UseStartup&lt;Startup&gt;();
    }
}
</code></pre></p><p>In order for our API gateway to use Ocelot we need to configure it in the <code>Startup</code> class. Replace the content of the <code>Startup.cs</code> file with the following:</p><p><pre><code>using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Ocelot.DependencyInjection;
using Ocelot.Middleware;

namespace ApiGateway
{
    public sealed class Startup
    {
        public readonly IConfiguration _configuration;

        public Startup(IConfiguration configuration)
        {
            _configuration &#x3D; configuration;
        }

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddOcelot(_configuration);
        }

        public void Configure(IApplicationBuilder app, IHostingEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            app.UseOcelot().Wait();
        }
    }
}
</code></pre></p><p>Now, let's run our API gateway (by default at <code>http://localhost:5000</code>):</p><p><pre><code>dotnet run</code></pre></p><p>When you access <code>http://localhost:5000/mocky/5185415ba171ea3a00704eed</code> from your browser you should get:</p><p><pre><code>{"hello": "world"}</code></pre></p><p>And what is <a href="https://www.mocky.io/">mocky.io</a>? Is an fake RESTful API where we can mock JSON responses.</p><div class="author"><img src="/images/marxjmoura.jpg" alt="marxjmoura"><div><p class="mb-3">I'm Marx J. Moura. In this blog I write about microservice architecture and web application development.</p><p><a href="https://github.com/marxjmoura/" class="p-1"><i class="fab fa-lg fa-github"></i> </a><a href="https://www.linkedin.com/in/marxjmoura/" class="p-1"><i class="fab fa-lg fa-linkedin"></i></a></p></div></div><div id="disqus_thread"></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/js/all.min.js" integrity="sha256-xzrHBImM2jn9oDLORlHS1/0ekn1VyypEkV1ALvUx8lU=" crossorigin="anonymous"></script><script src="/blog.min.js"></script><script>var disqus_config = function () {
      this.page.url = 'https://fullstack.app/posts/2019/08/20/api-gateway-with-aspnet-core-and-ocelot.html';
      this.page.identifier = '2019/08/20/api-gateway-with-aspnet-core-and-ocelot';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://fullstack-app.disqus.com/embed.js';
      s.setAttribute('data-timestamp', + new Date());
      (d.head || d.body).appendChild(s);
    })();</script></body></html>